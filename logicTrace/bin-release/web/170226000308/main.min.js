var LoadingUI=function(t){function i(){t.call(this),this.createView()}__extends(i,t);var e=(__define,i),n=e.prototype;return n.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},n.setProgress=function(t,i){this.textField.text="Loading..."+t+"/"+i},i}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var Main=function(t){function i(){t.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(i,t);var e=(__define,i),n=e.prototype;return n.onAddToStage=function(t){this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},n.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},n.onResourceLoadComplete=function(t){"preload"==t.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.createGameScene())},n.onItemLoadError=function(t){console.warn("Url:"+t.resItem.url+" has failed to load")},n.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t)},n.onResourceProgress=function(t){"preload"==t.groupName&&this.loadingView.setProgress(t.itemsLoaded,t.itemsTotal)},n.createGameScene=function(){var t=Client.app;t.init(this),t.acceptMsg(Client.Events.hudReset);var i=this.createBitmapByName("bg_jpg");this.addChild(i);var e=this.stage.stageWidth,n=this.stage.stageHeight;i.width=e,i.height=n},n.createGameScene2=function(){var t=this.createBitmapByName("bg_jpg");this.addChild(t);var i=this.stage.stageWidth,e=this.stage.stageHeight;t.width=i,t.height=e;var n=new egret.Shape;n.graphics.beginFill(0,.5),n.graphics.drawRect(0,0,i,172),n.graphics.endFill(),n.y=33,this.addChild(n);var o=this.createBitmapByName("egret_icon_png");this.addChild(o),o.x=26,o.y=33;var r=new egret.Shape;r.graphics.lineStyle(2,16777215),r.graphics.moveTo(0,0),r.graphics.lineTo(0,117),r.graphics.endFill(),r.x=172,r.y=61,this.addChild(r);var s=new egret.TextField;s.textColor=16777215,s.width=i-172,s.textAlign="center",s.text="Hello Egret",s.size=24,s.x=172,s.y=80,this.addChild(s);var a=new egret.TextField;this.addChild(a),a.alpha=0,a.width=i-172,a.textAlign=egret.HorizontalAlign.CENTER,a.size=24,a.textColor=16777215,a.x=172,a.y=135,this.textfield=a,RES.getResAsync("description_json",this.startAnimation,this)},n.createBitmapByName=function(t){var i=new egret.Bitmap,e=RES.getRes(t);return i.texture=e,i},n.startAnimation=function(t){for(var i=this,e=new egret.HtmlTextParser,n=[],o=0;o<t.length;o++)n.push(e.parser(t[o]));var r=i.textfield,s=-1,a=function(){s++,s>=n.length&&(s=0);var t=n[s];i.changeDescription(r,t);var e=egret.Tween.get(r);e.to({alpha:1},200),e.wait(2e3),e.to({alpha:0},200),e.call(a,i)};a()},n.changeDescription=function(t,i){t.textFlow=i},i}(egret.DisplayObjectContainer);egret.registerClass(Main,"Main");var Client;!function(t){var i=function(i){function e(e,n,o){i.call(this),this.emptyColor=t.config.emptyColor,this.boxSize=t.config.boxSize,this.brickSize=.72*this.boxSize,this.radiusSize=.2*this.boxSize,this.id=e,this.type=n,this.width=this.boxSize,this.height=this.boxSize,this.posi=_.clone(o),this.createBrick(),this.bind()}__extends(e,i);var n=(__define,e),o=n.prototype;return o.createBrick=function(){var t=this.brick=new egret.Shape;t.anchorOffsetX=this.brickSize/2,t.anchorOffsetY=this.brickSize/2,t.x=this.width/2,t.y=this.height/2,this.renderBrickColor(this.emptyColor),this.addChild(t)},o.renderBrickColor=function(t){var i=this.brick;i.graphics.beginFill(t),i.graphics.drawRoundRect(0,0,this.brickSize,this.brickSize,this.radiusSize),i.graphics.endFill()},o.bind=function(){var i=this;this.touchEnabled=!0,this.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(e){console.log(i.posi),t.app.acceptMsg(t.Events.boxTouchBegin,{posi:i.posi})},this),this.addEventListener(egret.TouchEvent.TOUCH_END,function(e){console.log(i.posi),t.app.acceptMsg(t.Events.boxTouchEnd,{posi:i.posi})},this)},e}(egret.Sprite);t.Box=i,egret.registerClass(i,"Client.Box"),function(t){t[t.source=0]="source",t[t.painted=1]="painted",t[t.undef=2]="undef"}(t.boxType||(t.boxType={}));t.boxType}(Client||(Client={}));var Client;!function(t){var i=function(i){function e(){i.call(this),this.dire=map2d.Direction.down,this.createImg(),this.width=this.img.width,this.height=this.img.height,this.anchorOffsetX=this.width/2,this.anchorOffsetY=this.height/2,this.bind()}__extends(e,i);var n=(__define,e),o=n.prototype;return o.createImg=function(){var t=this.img=new egret.Bitmap;t.texture=RES.getRes("cat_png"),this.img.scaleX=this.img.scaleY=.1,this.addChild(t)},o.enterMap=function(t){this.x=Math.floor(this.bound.width*Math.random())+this.bound.x,this.y=Math.floor(this.bound.height*Math.random())+this.bound.y;var i=this.img;egret.Tween.get(i).to({scaleX:1,scaleY:1},500,egret.Ease.backOut).call(t)},o.move=function(i){var e=this;if(void 0===i&&(i=!1),this.isMove){if(i||Math.random()<.05){var n=[map2d.Direction.up,map2d.Direction.right,map2d.Direction.down,map2d.Direction.left].filter(function(t){return t!=e.dire}),o=n[Math.floor(n.length*Math.random())];this.changeDire(o)}var r=t.config.catStep,s=this.dire==map2d.Direction.left?this.x-r:this.dire==map2d.Direction.right?this.x+r:this.x,a=this.dire==map2d.Direction.up?this.y-r:this.dire==map2d.Direction.down?this.y+r:this.y;s>=this.bound.x&&s<=this.bound.x+this.bound.width&&a>=this.bound.y&&a<=this.bound.y+this.bound.height?(this.x=s,this.y=a):this.move(!0)}},o.resume=function(){this.isMove=!0},o.stop=function(){this.isMove=!1},o.changeDire=function(t){this.dire=t,this.dire==map2d.Direction.right?this.skewY=180:this.dire==map2d.Direction.left&&(this.skewY=0)},o.bind=function(){var i,e=this;t.app.onMsg(t.Events.loadMap,function(){e.enterMap(function(){i&&i.pause(),e.rotation=0,e.scaleX=e.scaleY=1,e.resume()})}),t.app.onMsg(t.Events.win,function(){e.stop(),egret.Tween.get(e).to({scaleX:1.5,scaleY:1.5},200,egret.Ease.bounceInOut).call(function(){i=egret.Tween.get(e,{loop:!0}).to({rotation:30},500).to({rotation:-30},500).to({rotation:0},500)})});var n=new egret.Timer(100,0);n.start(),n.addEventListener(egret.TimerEvent.TIMER,function(){e.move()},this),this.touchEnabled=!0,this.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){var t=RES.getRes("miao_mp3");t.play(0,1)},this.img)},e}(egret.Sprite);t.Cat=i,egret.registerClass(i,"Client.Cat")}(Client||(Client={}));var Client;!function(t){var i=function(i){function e(){i.apply(this,arguments),this.touchStack=[],this.uiMsgDict={}}__extends(e,i);var n=(__define,e),o=n.prototype;return o.init=function(i){this.holder=i;var e=this.hud=new t.Hud;e.x=0,e.y=0,this.holder.stage.addChild(e);var n=this.map=new t.Map;n.x=0,n.y=e.height,n.width=this.holder.stage.stageWidth,n.height=this.holder.stage.stageHeight-this.hud.height,this.holder.stage.addChild(n),console.log(this.holder.stage.getChildIndex(n),"map")},o.acceptMsg=function(i,e){var n=this,o={};o[t.Events.hudReset]=function(i,e){var o={width:6,height:8};Server.app.createMap(o,function(i){console.log(i.boxList),n.map.loadData(i.boxList),n.pushMsg(t.Events.loadMap,i.boxList)})},o[t.Events.boxTouchBegin]=function(t,i){n.touchStack.length=0,n.touchStack.push(i.posi)},o[t.Events.boxTouchEnd]=function(i,e){n.touchStack.push(e.posi);var o=n.touchStack[0],r=n.touchStack[1];Server.app.drag({from:o,to:r},function(i){var e=i.dragInfo;e.err?console.log(e.err):(console.log(e.action),console.log(e.sourceId),console.log(e.posiList),n.map.process(e.action,e.sourceId,e.posiList),n.pushMsg(t.Events.drag,{action:e.action,count:e.posiList.length})),i.isWin&&n.pushMsg(t.Events.win)})},o[i](i,e)},o.pushMsg=function(t,i){var e=this.uiMsgDict,n=e[t]=e[t]||[];n.forEach(function(t){return t(i)})},o.onMsg=function(t,i){var e=this.uiMsgDict,n=e[t]=e[t]||[];n.push(i)},e}(egret.EventDispatcher);egret.registerClass(i,"App"),t.app=new i}(Client||(Client={}));var Client;!function(t){t.config={boxSize:100,emptyColor:13296127,lineColor:10802158,catStep:5,catCount:3}}(Client||(Client={}));var Client;!function(t){var i=function(){function t(){}var i=(__define,t);i.prototype;return t.hudReset="hud.reset",t.boxTouchBegin="box.touchBegin",t.boxTouchEnd="box.touchEnd",t.loadMap="client.loadMap",t.drag="client.drag",t.win="client.win",t}();t.Events=i,egret.registerClass(i,"Client.Events")}(Client||(Client={}));var Client;!function(t){var i=function(i){function e(){i.call(this),this.once(egret.Event.ADDED_TO_STAGE,this.addToStage,this),this.bind()}__extends(e,i);var n=(__define,e),o=n.prototype;return o.addToStage=function(){this.width=this.stage.stageWidth,this.height=100,this.createReset()},o.createProgress=function(i){var e=this.pbar=new t.PointBar(i);e.x=50,e.y=this.height/2,this.addChild(e)},o.createReset=function(){var i=this.reset=new egret.Bitmap;this.addChild(i),i.width=56,i.height=56,i.x=this.width-i.width-40,i.y=this.height/2-i.height/2,i.texture=RES.getRes("reset_png"),i.touchEnabled=!0,i.addEventListener(egret.TouchEvent.TOUCH_TAP,function(i){t.app.acceptMsg(t.Events.hudReset)},this)},o.bind=function(){var i=this;t.app.onMsg(t.Events.loadMap,function(t){var e=0;t.forEach(function(t){return t.forEach(function(t){if(t.type==Logic.boxType.source){var i=t;e+=i.paintedCount}})}),i.createProgress(e)}),t.app.onMsg(t.Events.drag,function(t){var e=i.pbar,n=e.currCount+("add"==t.action?t.count:-t.count);e.setProgress(n)})},e}(egret.Sprite);t.Hud=i,egret.registerClass(i,"Client.Hud")}(Client||(Client={}));var Client;!function(t){var i=function(i){function e(e,n){i.call(this),this.boxSize=t.config.boxSize,this.color=t.config.lineColor,this.from=e,this.to=n,this.width=this.height=this.boxSize,this.anchorOffsetX=this.width/2,this.anchorOffsetY=this.height/2,this.draw(this.from,this.to),this.from.x!=this.to.x&&(this.rotation=90)}__extends(e,i);var n=(__define,e),o=n.prototype;return o.draw=function(t,i){var e=new egret.Shape;e.width=this.width,e.height=this.height,e.graphics.lineStyle(.1*this.boxSize,this.color),e.graphics.moveTo(this.width/2,0),e.graphics.lineTo(this.width/2,this.height),this.addChild(e)},o.is=function(t,i){return map2d.isPositionEqual(this.from,t)&&map2d.isPositionEqual(this.to,i)||map2d.isPositionEqual(this.from,i)&&map2d.isPositionEqual(this.to,t)},e}(egret.Sprite);t.Line=i,egret.registerClass(i,"Client.Line")}(Client||(Client={}));var Client;!function(t){var i=function(i){function e(){i.call(this),this.boxSize=t.config.boxSize,this.catList=[],this.lineList=[],this.once(egret.Event.ADDED_TO_STAGE,this.addToStage,this),this.boxList=[],this.bind()}__extends(e,i);var n=(__define,e),o=n.prototype;return o.addToStage=function(){this.width=this.stage.stageWidth},o.addCatList=function(){for(var i=t.config.catCount,e=this.catList.length;i--;){var n=void 0;e?(n=this.catList[i],console.log("use cache cat")):(n=new t.Cat,this.catList.push(n),console.log("use new cat")),n.bound={x:this.x+n.width/2,y:this.y+n.height/2,width:this.width-n.width,height:this.height-n.height},this.addChild(n)}},o.setColorMap=function(t){var i=this;this.colorMap={},_.flatten(t).filter(function(t){return t.type==Logic.boxType.source}).forEach(function(t){i.colorMap[t.id]=Math.floor(16777215*Math.random())})},o.loadData=function(t){var i=this;this.setColorMap(t),this.removeChildren(),t.forEach(function(t,e){t.forEach(function(t,e){i.addBox(t)})}),this.width=t[0].length*this.boxSize,this.height=t.length*this.boxSize,this.x=this.stage.stageWidth/2-t[0].length*this.boxSize/2,this.addCatList()},o.addBox=function(i){var e;if(i.type==Logic.boxType.source){var n=i;e=new t.SourceBox(n.id,n.posi,this.colorMap[n.id],n.paintedCount)}else if(i.type==Logic.boxType.painted){var o=i;e=new t.PaintedBox(o.id,o.posi)}else{var r=i;e=new t.UndefBox(r.id,r.posi)}this.addChild(e),this.fallBox(e);var s=this.boxList,a=s[e.posi.y]=s[e.posi.y]||[];a[e.posi.x]=e},o.fallBox=function(t){var i={x:t.posi.x*this.boxSize,y:t.posi.y*this.boxSize};t.x=i.x;var e=200+100*Math.random()*t.posi.y;egret.Tween.get(t).to({y:i.y},e,egret.Ease.bounceOut)},o.process=function(t,i,e){var n=this,o=this.boxList;"add"==t?(e.map(function(t){return o[t.y][t.x]}).forEach(function(t){t.paint(!0,i,n.colorMap[i])}),this.drawLineList(e,!1)):"sub"==t&&(this.drawLineList(e,!0),e.map(function(t){return o[t.y][t.x]}).forEach(function(t){t.paint(!1)}));var r=this.findSourceBox(i);r.isFull=this.sumPaintedCount(i)==r.paintedCount,r.tryRotate()},o.drawLine=function(i,e,n){var o=this;if(void 0===n&&(n=!0),n)this.lineList.forEach(function(t,n){t.is(i,e)&&(o.removeChild(t),o.lineList.splice(n,1))});else{var r=new t.Line(i,e);r.x=(i.x+e.x+1)/2*this.boxSize,r.y=(i.y+e.y+1)/2*this.boxSize,this.addChild(r),this.setChildIndex(r,0),this.lineList.push(r)}},o.drawLineList=function(i,e){var n=this;if(i.length){var o=function(t,i){return 1e4*t.x+t.y-(1e4*i.x+i.y)},r=i.map(function(t){return{x:t.x,y:t.y}}).sort(o),s=void 0,a=function(i,e){var o,r=n.boxList[i.y][i.x];return map2d.nearRange(i,1).filter(function(t){return t.x>=0&&t.x<n.boxList[0].length&&t.y>=0&&t.y<n.boxList.length}).some(function(i){if(e.some(function(t){return map2d.isPositionEqual(i,t)}))return!1;var s=n.boxList[i.y][i.x];if(s.type==t.boxType.painted){var a=s;if(a.sourceId==r.sourceId)return o=i,!0}else if(s.type==t.boxType.source){var h=s;if(h.id==r.sourceId)return o=i,!0}}),o};s=a(r[0],r)||a(r[r.length-1],r),r.push(s),r=r.sort(o),r.forEach(function(t){return console.log(t.x,t.y)}),r.forEach(function(t,i,o){if(i!=o.length-1){var r=o[i+1];n.drawLine(t,r,e)}})}},o.celebrate=function(){},o.sumPaintedCount=function(i){return _.flatten(this.boxList).filter(function(e){return e.type==t.boxType.painted&&e.sourceId==i}).length},o.findSourceBox=function(i){return _.find(_.flatten(this.boxList),function(e){return e.type==t.boxType.source&&e.id==i})},o.bind=function(){t.app.onMsg(t.Events.win,function(){var t=RES.getRes("win_mp3");t.play(0,1)})},e}(egret.Sprite);t.Map=i,egret.registerClass(i,"Client.Map")}(Client||(Client={}));var Client;!function(t){var i=function(i){function e(e,n){i.call(this,e,t.boxType.painted,n)}__extends(e,i);var n=(__define,e),o=n.prototype;return o.paint=function(t,i,e){t?(this.sourceId=i,this.renderBrickColor(e)):(this.sourceId=void 0,this.renderBrickColor(this.emptyColor))},e}(t.Box);t.PaintedBox=i,egret.registerClass(i,"Client.PaintedBox")}(Client||(Client={}));var Client;!function(t){var i=function(i){function e(t){i.call(this),this.barWidth=300,this.barHeight=50,this.barRadius=this.barHeight/2,this.currCount=0,this.totalCount=t,this.width=this.barWidth,this.height=this.barHeight,this.createBar(),this.bind()}__extends(e,i);var n=(__define,e),o=n.prototype;return o.setProgress=function(t){this.currCount=t;var i=this.currCount/this.totalCount;this.renderBar(i)},o.createBar=function(){var t=new egret.TextField;t.text="SCORE:",t.anchorOffsetY=t.height/2,this.addChild(t);var i=150,e=new egret.Shape;e.graphics.beginFill(13296127,.4),e.graphics.drawRoundRect(0,0,this.barWidth,this.barHeight,this.barRadius),e.graphics.endFill(),e.x=i,e.anchorOffsetY=e.height/2,this.addChild(e);var n=this.bar=new egret.Shape;n.x=i,n.graphics.beginFill(12648254,.8),n.graphics.drawRoundRect(0,0,this.barWidth,this.barHeight,this.barRadius),n.graphics.endFill(),n.anchorOffsetY=n.height/2,this.addChild(n),this.setProgress(0)},o.renderBar=function(t){var i=this.bar;egret.Tween.get(i).to({scaleX:t},500,egret.Ease.bounceInOut)},o.bind=function(){var i=this;t.app.onMsg(t.Events.loadMap,function(){return i.renderBar(0)})},e}(egret.Sprite);t.PointBar=i,egret.registerClass(i,"Client.PointBar")}(Client||(Client={}));var Client;!function(t){var i=function(){function t(){}var i=(__define,t);i.prototype;return t.createMap="req.createMap",t.dragBox="req.dragBox",t.reset="req.reset",t}();t.Reqs=i,egret.registerClass(i,"Client.Reqs")}(Client||(Client={}));var Client;!function(t){var i=function(i){function e(e,n,o,r){i.call(this,e,t.boxType.source,n),this.color=o,this.paintedCount=r,this.isFull=!1,this.createCountText(),this.renderBrickColor(this.color)}__extends(e,i);var n=(__define,e),o=n.prototype;return o.createCountText=function(){var t=this.countText=new egret.TextField;t.text=this.paintedCount.toString(),t.size=this.boxSize/2,t.anchorOffsetX=t.width/2,t.anchorOffsetY=t.height/2,t.x=this.boxSize/2,t.y=this.boxSize/2,this.addChild(t)},o.tryRotate=function(){var t=this,i=this.isFull?45:0,e=function(){};if(this.brick.rotation!=i&&(e=function(){return egret.Tween.get(t.brick).to({rotation:i},500)}),this.isFull){var n=this.countText;egret.Tween.get(n).to({rotation:360},500).call(e).call(this.kaca,this)}else e()},o.kaca=function(){var t=RES.getRes("kaca_mp3");t.play(0,1)},e}(t.Box);t.SourceBox=i,egret.registerClass(i,"Client.SourceBox")}(Client||(Client={}));var Client;!function(t){var i=function(i){function e(e,n){i.call(this,e,t.boxType.undef,n);var o=new egret.TextField;o.textColor=9287373,o.text="U",o.width=this.width,o.height=this.height,o.verticalAlign=egret.VerticalAlign.MIDDLE,o.textAlign=egret.HorizontalAlign.CENTER,this.addChild(o)}__extends(e,i);var n=(__define,e);n.prototype;return e}(t.Box);t.UndefBox=i,egret.registerClass(i,"Client.UndefBox")}(Client||(Client={}));var Logic;!function(t){var i=function(){function i(i,e){var n=this;this.width=i,this.height=e,this.insertMax=100,this.mergeMax=100;this.boxList=[];this.visit(function(i,e,n,o){return o[n][e]=t.Box.create(t.boxType.undef,{posi:{x:e,y:n}}),!0});for(var o=100,r=function(){var t=s.findAllUndef(),i=!1;if(t.some(function(t){var e=n.findExtendList(t.posi);return e.length?(i=!0,!0):void 0}),!i)return"break";for(s.insertMax=100;s.insert(););},s=this;;){var a=r();if("break"===a)break}for(console.log("count:",o);this.merge(););}var e=(__define,i),n=e.prototype;return n.process=function(t,i,e){var n=this,o=this.findSource(i);e.map(function(t){return n.boxList[t.y][t.x]}).forEach(function(e){"add"==t?(e.isPainted=!0,e.dragSourceId=i,o.paintIdList.push(e.id)):"sub"==t&&(e.isPainted=!1,e.dragSourceId=void 0,o.paintIdList=o.paintIdList.filter(function(t){return t!=e.id}))})},n.drag=function(i,e){var n=this;if(void 0===map2d.getDirection(i,e))return{err:"NOT in same line"};if(map2d.isPositionEqual(i,e))return{err:"from point EQUAL to point"};var o,r=this.boxList[i.y][i.x];if(r.type==t.boxType.source){o="add";var s=r,a=map2d.getBetween(i,e),h=Math.max(Math.min(s.paintedCount-s.paintIdList.length,a.length+1),0),c=map2d.lineRange(i,h,map2d.getDirection(e,i));return this.checkCross(c)?{err:"path CROSS"}:(c.forEach(function(t){n.paint("add",t,s.id)}),{action:o,posiList:c,sourceId:s.id,err:void 0})}if(r.type==t.boxType.painted){var d=r;if(!d.isPainted)return{err:"paintBox is NOT painted"};var u=this.findSource(d.dragSourceId);if(map2d.getBetween(i,e).some(function(t){return map2d.isPositionEqual(t,u.posi)}))return{err:"soureceBox is BETWEEN from and to"};var p=map2d.getDirection(e,i),f=map2d.getDirection(i,u.posi);if((p+f)%2)return{err:"NOT same direction"};o=p==f?"add":"sub";var a=map2d.getBetween(i,e),c=void 0;if("add"==o){var h=Math.max(Math.min(u.paintedCount-u.paintIdList.length,a.length+1),0);if(c=map2d.lineRange(i,h,map2d.getDirection(e,i)),this.checkCross(c))return{err:"path CROSS"};c.forEach(function(t){return n.paint("add",t,u.id)})}else"sub"==o&&(c=a.concat(i),c.forEach(function(t){return n.paint("sub",t,u.id)}));return{err:void 0,action:o,posiList:c,sourceId:u.id}}},n.checkCross=function(i){var e=this,n=!!_.find(i,function(i){var n=e.boxList[i.y][i.x];if(n.type!=t.boxType.painted)return!0;var o=n;return o.isPainted?!0:void 0});return n},n.paint=function(t,i,e){var n=this.findSource(e),o=this.boxList[i.y][i.x];"add"==t?(o.isPainted=!0,o.dragSourceId=n.id,n.paintIdList=n.paintIdList.concat(o.id)):"sub"==t&&(o.isPainted=!1,o.dragSourceId=void 0,n.paintIdList=n.paintIdList.filter(function(t){return t!=o.id}))},n.isWin=function(){var i=!0;return this.visit(function(e,n,o,r){if(e.type==t.boxType.painted){var s=e;if(!s.isPainted)return i=!1,!1}}),i},n.log=function(){for(var t=[],i=0;i<arguments.length;i++)t[i-0]=arguments[i]},n.visit=function(t){for(var i=0;i<this.height;i++){this.boxList[i]=this.boxList[i]||[];for(var e=0;e<this.width;e++){var n=this.boxList[i][e];if(t(n,e,i,this.boxList)===!1)return}}},n.insert=function(){var i=this.findUndef();if(!i)return!1;var e=this.findExtendList(i.posi);if(!e.length)return!1;var n=1,o=this.boxList[i.posi.y][i.posi.x]=t.Box.create(t.boxType.source,{posi:i.posi});for(this.log("create sourece:",o.posi);this.passRate(n)&&e.length;){o.paintedCount++;var r=Math.floor(Math.random()*e.length),s=e[r];e.splice(r,1);var a=this.boxList[s.y][s.x]=t.Box.create(t.boxType.painted,{posi:s,sourceId:o.id});if(this.log("create painted",this.findSource(a.sourceId).posi,a.posi),n*=.75,this.insertMax--,!this.insertMax)return!1}return!0},n.merge=function(){var i=this,e=this.findUndef();if(!e)return!1;var n=map2d.nearRange(e.posi,1).filter(function(t){return!i.isOut(t)}),o=!1;return o=n.filter(function(e){return i.boxList[e.y][e.x].type==t.boxType.painted}).some(function(n){var o=i.boxList[n.y][n.x],r=i.findSource(o.sourceId);return map2d.getDirection(o.posi,r.posi)==map2d.getDirection(e.posi,r.posi)?(i.boxList[e.posi.y][e.posi.x]=t.Box.create(t.boxType.painted,{posi:e.posi,sourceId:r.id}),r.paintedCount++,i.log("link:",r.posi,o.posi,e.posi),!0):!1}),o||n.some(function(n){var o=i.boxList[n.y][n.x];if(o.type==t.boxType.source){var r=o,s=i.boxList[e.posi.y][e.posi.x]=t.Box.create(t.boxType.painted,{posi:e.posi});s.sourceId=r.id,r.paintedCount++,i.log("union un:",r.posi,s.posi)}else if(o.type==t.boxType.painted){var s=o,a=i.findSource(s.sourceId),r=i.boxList[s.posi.y][s.posi.x]=t.Box.create(t.boxType.source,{posi:s.posi}),h=i.boxList[e.posi.y][e.posi.x]=t.Box.create(t.boxType.painted,{posi:e.posi});if(h.sourceId=r.id,r.paintedCount++,1==a.paintedCount){var c=i.boxList[a.posi.y][a.posi.x]=t.Box.create(t.boxType.painted,{posi:a.posi});c.sourceId=r.id,r.paintedCount++}else a.paintedCount--;i.log("cut pa:",r.posi,s.posi)}return!0}),this.mergeMax--,this.mergeMax?!0:!1},n.findSource=function(t){var i;return this.visit(function(e){return e.id==t?(i=e,!1):!0}),i},n.findAllUndef=function(){var i=[];return this.visit(function(e,n,o,r){return e.type==t.boxType.undef&&i.push(e),!0}),i},n.findUndef=function(){var t=void 0,i=this.findAllUndef();return i.length&&(t=i[Math.floor(Math.random()*i.length)]),t},n.findExtendList=function(i){var e,n=this;return e=map2d.nearRange(i,1).filter(function(t){return!n.isOut(t)}).filter(function(i){return n.boxList[i.y][i.x].type==t.boxType.undef})},n.isOut=function(t){return t.x<0||t.y<0||t.x>=this.width||t.y>=this.height},n.passRate=function(t){return Math.random()<=t},i}();t.Map=i,egret.registerClass(i,"Logic.Map")}(Logic||(Logic={}));var Logic;!function(t){var i=function(){function i(){this.id=parseInt(_.uniqueId())}var e=(__define,i);e.prototype;return i.create=function(i,e){var n;return i==t.boxType.source?n=new t.SourceBox:i==t.boxType.blank?n=new t.BlankBox:i==t.boxType.painted?n=new t.PaintedBox(e.sourceId):i==t.boxType.undef&&(n=new t.UndefBox),n.posi=_.clone(e.posi),n},i}();t.Box=i,egret.registerClass(i,"Logic.Box")}(Logic||(Logic={}));var Logic;!function(t){var i=function(i){function e(){i.call(this),this.type=t.boxType.blank}__extends(e,i);var n=(__define,e);n.prototype;return e}(t.Box);t.BlankBox=i,egret.registerClass(i,"Logic.BlankBox")}(Logic||(Logic={}));var map2d;!function(t){function i(t,i,e){var n,o,r=[];e==g.up?(n=0,o=1):e==g.right?(n=1,o=0):e==g.down?(n=0,o=-1):e==g.left&&(n=-1,o=0);for(var s=0;i>s;s++)r.push({x:t.x+n*(s+1),y:t.y+o*(s+1)});return r}function e(t,i,e){var n,o,r=[];e==l.upRight?(n=1,o=1):e==l.downRight?(n=1,o=-1):e==l.downLeft?(n=-1,o=-1):e==l.upLeft&&(n=-1,o=1);for(var s=0;i>s;s++)r.push({x:t.x+n*(s+1),y:t.y+o*(s+1)});return r}function n(t,e){for(var n=[],o=0;o<v.length;o++){var r=v[o];n=n.concat(i(t,e,r))}return n}function o(t,i){for(var n=[],o=0;o<x.length;o++){var r=x[o];n=n.concat(e(t,i,r))}return n}function r(t,i){for(var e=[],n=-i;i>=n;n++)for(var o=-i;i>=o;o++)(0!=n||0!=o)&&e.push({x:n+t.x,y:o+t.y});return e}function s(t,i){for(var e=[],n=-i;i>=n;n++)for(var o=-i;i>=o;o++){var r=Math.abs(n)+Math.abs(o);i>=r&&0!=r&&e.push({x:n+t.x,y:o+t.y})}return e}function a(t,i){for(var e=[],n=[t.x,i.x].sort(function(t,i){return t-i}),o=n[0],r=n[1],s=[t.y,i.y].sort(function(t,i){return t-i}),a=s[0],h=s[1],c=o;r>=c;c++)for(var u=a;h>=u;u++)e.push({x:c,y:u});return e=d(e,[t,i])}function h(t){return[t.x,t.y].join("-")}function c(t){return _.uniq(t,h)}function d(t,i){var e=[],n=_.indexBy(t,h),o=_.indexBy(i,h);return _.each(n,function(t,i){o[i]||e.push(_.clone(t))}),e}function u(t,i){var e,n=t.x,o=t.y,r=i.x,s=i.y;return n==r||o==s?e=n==r?o>s?g.up:g.down:n>r?g.right:g.left:void 0}function p(t,i){var e,n=t.x,o=t.y,r=i.x,s=i.y;return 1==Math.abs((o-s)/(n-r))?e=o>s?n>r?l.upRight:l.upLeft:n>r?l.downRight:l.downLeft:void 0}function f(t,i){return t&&i?t.x==i.x&&t.y==i.y:!1}!function(t){t[t.up=0]="up",t[t.right=1]="right",t[t.down=2]="down",t[t.left=3]="left"}(t.Direction||(t.Direction={}));var g=t.Direction;!function(t){t[t.upRight=0]="upRight",t[t.downRight=1]="downRight",t[t.downLeft=2]="downLeft",t[t.upLeft=3]="upLeft"}(t.SlashDirection||(t.SlashDirection={}));var l=t.SlashDirection,v=[g.up,g.right,g.down,g.left],x=[l.upRight,l.downRight,l.downLeft,l.upLeft];t.lineRange=i,t.slashRange=e,t.nearRange=n,t.nearSlashRange=o,t.circleRange=r,t.manhattanRange=s,t.getBetween=a,t.unique=c,t.sub=d,t.getDirection=u,t.getSlashDirection=p,t.isPositionEqual=f}(map2d||(map2d={}));var Logic;!function(t){var i=function(i){function e(e){i.call(this),this.isPainted=!1,this.sourceId=e,this.type=t.boxType.painted}__extends(e,i);var n=(__define,e);n.prototype;return e}(t.Box);t.PaintedBox=i,egret.registerClass(i,"Logic.PaintedBox")}(Logic||(Logic={}));var Logic;!function(t){var i=function(i){function e(){i.call(this),this.type=t.boxType.source,this.paintedCount=0,this.paintIdList=[]}__extends(e,i);var n=(__define,e);n.prototype;return e}(t.Box);t.SourceBox=i,egret.registerClass(i,"Logic.SourceBox")}(Logic||(Logic={}));var Logic;!function(t){!function(t){t[t.source=0]="source",t[t.blank=1]="blank",t[t.painted=2]="painted",t[t.undef=3]="undef"}(t.boxType||(t.boxType={}));t.boxType}(Logic||(Logic={}));var Logic;!function(t){var i=function(i){function e(){i.call(this),this.type=t.boxType.undef}__extends(e,i);var n=(__define,e);n.prototype;return e}(t.Box);t.UndefBox=i,egret.registerClass(i,"Logic.UndefBox")}(Logic||(Logic={}));var Server;!function(t){var i=function(){function t(){}var i=(__define,t),e=i.prototype;return e.createMap=function(t,i){var e=this.map=new Logic.Map(t.width,t.height);i(e)},e.drag=function(t,i){if(!this.map)return void i({err:"NO map"});var e=this.map.drag(t.from,t.to),n=this.map.isWin();i({dragInfo:e,isWin:n})},t}();egret.registerClass(i,"App"),t.app=new i}(Server||(Server={}));var Server;!function(t){t.config={}}(Server||(Server={}));